name: Release

on:
  release:
    types: [published]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build WASM
    runs-on: ubuntu-latest
    outputs:
      wasm_file: ${{ steps.package_name.outputs.wasm_file }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-wasip2

    - name: Cache cargo registry
      uses: actions/cache@v5
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Extract package name from Cargo.toml
      id: package_name
      run: |
        PACKAGE_NAME=$(grep '^name = ' Cargo.toml | sed 's/name = "\(.*\)"/\1/' | tr '-' '_')
        echo "wasm_file=${PACKAGE_NAME}.wasm" >> $GITHUB_OUTPUT
        echo "Package name: ${PACKAGE_NAME}"
        echo "WASM file: ${PACKAGE_NAME}.wasm"

    - name: Build optimized WASM
      run: |
        # Build with size optimizations
        cargo build --release --target wasm32-wasip2

        # Copy WASM file for release (Rust converts hyphens to underscores in binary names)
        cp target/wasm32-wasip2/release/${{ steps.package_name.outputs.wasm_file }} ${{ steps.package_name.outputs.wasm_file }}

        echo "WASM file size:"
        ls -lh ${{ steps.package_name.outputs.wasm_file }}
        echo "Size in bytes:"
        wc -c ${{ steps.package_name.outputs.wasm_file }}

        echo "Note: wasm-opt does not support WASM components yet (see https://github.com/WebAssembly/binaryen/issues/6728)"
        echo "Using Cargo optimizations only (opt-level=z, lto=true, strip=true)"

    - name: Create release archive
      run: |
        # Create a release archive with the WASM file and documentation
        mkdir -p release
        cp ${{ steps.package_name.outputs.wasm_file }} release/
        cp README.md release/ 2>/dev/null || echo "No README.md found"

        # Create a zip file
        zip -r ${{ steps.package_name.outputs.wasm_file }}-${{ github.event.release.tag_name }}.zip release/

        echo "Release archive created:"
        ls -lh ${{ steps.package_name.outputs.wasm_file }}-${{ github.event.release.tag_name }}.zip

    - name: Upload WASM artifact
      uses: actions/upload-artifact@v6
      with:
        name: wasm-build
        path: |
          ${{ steps.package_name.outputs.wasm_file }}
          ${{ steps.package_name.outputs.wasm_file }}-${{ github.event.release.tag_name }}.zip
        retention-days: 1

  attach-assets:
    name: Attach Assets to Release
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v7
      with:
        name: wasm-build

    - name: Display downloaded files
      run: |
        echo "Downloaded artifacts:"
        ls -lh

    - name: Attach assets to release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.release.tag_name }}
        files: |
          ${{ needs.build.outputs.wasm_file }}
          ${{ needs.build.outputs.wasm_file }}-${{ github.event.release.tag_name }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
